<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>METEBABA RAPORATÖR</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            /* Kamuflaj resminin saydam hali ile arka plan */
            background-color: #f5f5f5; /* Fallback */
            background-image: url('/static/camouflage.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('/static/camouflage.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.15; /* Çok saydam */
            z-index: -1;
            pointer-events: none;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.95); /* Hafif beyaz overlay */
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: visible; /* Badge'in taşmasına izin ver */
            position: relative;
        }
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('/static/camouflage.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.45; /* Daha belirgin kamuflaj */
            border-radius: 8px;
            z-index: 0;
            pointer-events: none;
        }
        .container > * {
            position: relative;
            z-index: 1;
        }
        .title-wrapper {
            position: relative;
            margin-bottom: 30px;
            text-align: center;
        }
        .title-top {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 5px; /* Boşluğu azalt (10px -> 5px) */
        }
        .crown-left, .crown-right {
            max-width: 50px;
            height: auto;
            flex-shrink: 0;
            /* Beyaz çerçeveyi kaldırmak için - multiply beyazı şeffaf yapar */
            mix-blend-mode: multiply;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        /* Eğer multiply işe yaramazsa, darken veya screen deneyebiliriz */
        /* Ancak en iyi çözüm PNG'nin şeffaf arka planlı olması */
        .title-top h1 {
            margin: 0;
            font-family: 'Fredoka One', cursive;
            font-size: 36px;
            letter-spacing: 2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: #667eea; /* Fallback for browsers that don't support gradient text */
        }
        .title-bottom {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            padding-left: 60px; /* RAPORATÖR'ü sağa kaydır */
        }
        .title-bottom h2 {
            margin: 0;
            font-family: 'Fredoka One', cursive;
            font-size: 36px; /* METEBABA ile aynı boyut */
            letter-spacing: 2px; /* METEBABA ile aynı letter-spacing */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: #667eea; /* Fallback */
        }
        .title-badge-wrapper {
            display: flex;
            align-items: center;
            position: relative;
            margin-left: -60px; /* RAPORATÖR'ün üzerine gelsin */
            margin-top: 50px;
        }
        .title-badge {
            max-width: 130px;
            height: auto;
            opacity: 0.9;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            position: relative;
            z-index: 2;
        }
        .hakki-sticker {
            max-width: 40px; /* Daha da küçültüldü */
            height: auto;
            margin-left: -40px; /* Damganın sağ tarafına geçmesi için sol margin eklendi */
            margin-top: 10px; /* Biraz daha aşağıya, damganın sağ alt/orta kısmına doğru */
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            z-index: 3;
            transition: transform 0.3s ease;
        }
        .hakki-sticker:hover {
            transform: scale(1.1) rotate(-5deg);
        }
        
        @supports (-webkit-background-clip: text) {
            .title-top h1,
            .title-bottom h2 {
                color: transparent;
            }
        }
        
        /* Mobil için responsive */
        @media (max-width: 600px) {
            .title-top h1 {
                font-size: 28px;
            }
            .title-bottom h2 {
                font-size: 28px; /* METEBABA ile aynı boyut */
            }
            .crown-left, .crown-right {
                max-width: 40px;
            }
            .title-badge {
                max-width: 90px; /* Mobilde de biraz büyük */
            }
        }
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333; /* Daha koyu renk */
            font-size: 17px; /* Biraz daha büyük */
            text-shadow: 0 1px 2px rgba(255,255,255,0.8); /* Okunabilirlik için hafif gölge */
        }
        input[type="text"],
        input[type="date"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #999; /* Daha belirgin border */
            border-radius: 4px;
            font-family: Arial, sans-serif;
            color: #222; /* Daha koyu yazı rengi */
            font-weight: 500; /* Biraz daha kalın */
            background-color: rgba(255, 255, 255, 0.95); /* Daha opak arka plan */
        }
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #999; /* Daha belirgin border */
            border-radius: 4px;
            font-family: Arial, sans-serif;
            resize: vertical;
            color: #222; /* Daha koyu yazı rengi */
            font-weight: 500; /* Biraz daha kalın */
            background-color: rgba(255, 255, 255, 0.95); /* Daha opak arka plan */
        }
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .button-wrapper {
            position: relative;
            width: 100%;
            margin-top: 20px;
            overflow: visible; /* Badge'in taşmasına izin ver */
        }
        button {
            width: 100%;
            padding: 20px 15px 25px 15px; /* Üst, sağ, alt, sol - alt padding artırıldı */
            font-size: 18px;
            font-weight: bold;
            /* Gerçek kamuflaj resmi ile kaplama */
            background-color: #5a4fcf; /* Fallback renk */
            background-image: url('/static/camouflage.png');
            background-size: cover; /* Butonu tamamen kapla */
            background-position: center;
            background-repeat: no-repeat;
            /* Orijinal renkleri koru - filtre yok */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: flex-end; /* Yazıyı aşağı kaydır */
            justify-content: center;
            box-shadow: 0 4px 15px rgba(90, 79, 207, 0.4);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* Yazıyı daha okunabilir yap */
        }
        button:hover {
            filter: brightness(1.1); /* Sadece hafif parlaklık artışı */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }
        .button-badge {
            position: absolute;
            top: -50px; /* PNG'nin çoğu butonun üstünde, sadece alt kısmı (kollar) butona değecek */
            left: 50%; /* Butona göre ortala */
            transform: translateX(-50%); /* Tam ortala */
            z-index: 3; /* Butonun üzerinde olması için */
            max-width: 120px; /* Küçültüldü */
            height: auto;
            pointer-events: none;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .error {
            color: #d32f2f;
            margin-top: 10px;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="title-wrapper">
        <div class="title-top">
            <img src="/static/crown.png" alt="Crown" class="crown-left">
            <h1>METEBABA</h1>
            <img src="/static/crown.png" alt="Crown" class="crown-right">
        </div>
        <div class="title-bottom">
            <h2>RAPORATÖR</h2>
            <div class="title-badge-wrapper">
                <img src="/static/27.png" alt="Badge" class="title-badge">
                <img src="/static/hakkı.png" alt="Hakkı" class="hakki-sticker">
            </div>
        </div>
    </div>

    <form method="POST" action="/generator-test" enctype="multipart/form-data" id="reportForm">
        
        <div class="form-group">
            <label for="proje">Proje</label>
            <div style="display: flex; gap: 20px; margin-top: 8px;">
                <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
                    <input type="radio" id="proje_fetihtepe" name="proje" value="Fetihtepe" checked style="width: auto; margin: 0;">
                    <span>Fetihtepe</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
                    <input type="radio" id="proje_arap_camii" name="proje" value="Arap Camii" style="width: auto; margin: 0;">
                    <span>Arap Camii</span>
                </label>
            </div>
            <div class="help-text">Rapor için proje seçin</div>
        </div>

        <div class="form-group">
            <label for="tarih">Tarih</label>
            <input type="date" id="tarih" name="tarih" required>
            <div style="display: flex; gap: 20px; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
                    <input type="radio" id="tarih_gunluk" name="tarih_tipi" value="gunluk" checked style="width: auto; margin: 0;">
                    <span>Günlük</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
                    <input type="radio" id="tarih_3gunluk" name="tarih_tipi" value="3gunluk" style="width: auto; margin: 0;">
                    <span>3 Günlük (Oto)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
                    <input type="radio" id="tarih_3gunluk_ozel" name="tarih_tipi" value="3gunluk_ozel" style="width: auto; margin: 0;">
                    <span>3 Günlük (Özel)</span>
                </label>
            </div>
            <div id="ozel_tarihler" style="display: none; margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.05); border-radius: 4px;">
                <div style="margin-bottom: 10px;">
                    <label for="tarih2" style="font-size: 14px;">2. Gün</label>
                    <input type="date" id="tarih2" name="tarih2">
                </div>
                <div>
                    <label for="tarih3" style="font-size: 14px;">3. Gün</label>
                    <input type="date" id="tarih3" name="tarih3">
                </div>
            </div>
            <div class="help-text">Rapor tarihini seçin ve tipini belirleyin</div>
        </div>

        <div class="form-group">
            <label for="rapor_no">Rapor No</label>
            <input type="text" id="rapor_no" name="rapor_no" placeholder="Örn: 1, 2, 3..." required>
            <div class="help-text">Günlük rapor numarasını girin</div>
        </div>

        <div class="form-group">
            <label for="yapilan_isler">Yapılan İşler</label>
            <textarea id="yapilan_isler" name="yapilan_isler" placeholder="Her satıra bir iş yazın. Örn:&#10;• Betonarme taşıyıcı sistemin durum tespiti çalışmaları devam etmektedir.&#10;• Seçilen kolon ve kirişlerde sıyırma işlemlerine devam edilmiştir." required></textarea>
            <div class="help-text">Her satıra bir iş yazın. Başına • (nokta) eklemenize gerek yok, otomatik eklenir.</div>
        </div>

        <div class="form-group">
            <label for="photos">Fotoğraflar (en fazla 8 adet)</label>
            <input type="file" id="photos" name="photos" multiple accept="image/*">
            <div class="help-text">JPG, PNG veya JPEG formatında fotoğraf yükleyebilirsiniz</div>
        </div>

        <div class="error" id="errorMessage"></div>

        <div class="button-wrapper">
            <img src="/static/badge.png" alt="Badge" class="button-badge" id="buttonBadge">
            <button type="submit" id="submitBtn">Rapor Oluştur</button>
        </div>

    </form>
</div>

<script>
    async function resizeImage(file, maxWidth = 1200, maxHeight = 1200, quality = 0.8) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob((blob) => {
                        const resizedFile = new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        resolve(resizedFile);
                    }, 'image/jpeg', quality);
                };
            };
        });
    }

    document.querySelectorAll('input[name="tarih_tipi"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const ozelTarihler = document.getElementById('ozel_tarihler');
            if (this.value === '3gunluk_ozel') {
                ozelTarihler.style.display = 'block';
                document.getElementById('tarih2').required = true;
                document.getElementById('tarih3').required = true;
            } else {
                ozelTarihler.style.display = 'none';
                document.getElementById('tarih2').required = false;
                document.getElementById('tarih3').required = false;
            }
        });
    });

    document.getElementById('reportForm').addEventListener('submit', async function(e) {
        e.preventDefault(); // Formun normal gönderimini durdur
        
        const submitBtn = document.getElementById('submitBtn');
        const errorDiv = document.getElementById('errorMessage');
        const form = e.target;
        
        // Tarih kontrolü - bugünün tarihini varsayılan yap
        const tarihInput = document.getElementById('tarih');
        if (!tarihInput.value) {
            const today = new Date().toISOString().split('T')[0];
            tarihInput.value = today;
        }
        
        // Butonu devre dışı bırak
        submitBtn.disabled = true;
        submitBtn.textContent = 'Fotoğraflar İşleniyor...';
        errorDiv.style.display = 'none';

        try {
            const formData = new FormData(form);
            const photoInput = document.getElementById('photos');
            const files = photoInput.files;

            if (files.length > 0) {
                // Mevcut photos'ları temizle (tekrar ekleyeceğiz)
                formData.delete('photos');
                
                // Fotoğrafları tek tek işle ve FormData'ya ekle
                for (let i = 0; i < Math.min(files.length, 8); i++) {
                    submitBtn.textContent = `Fotoğraf ${i + 1}/${Math.min(files.length, 8)} İşleniyor...`;
                    const resizedFile = await resizeImage(files[i]);
                    formData.append('photos', resizedFile);
                }
            }

            submitBtn.textContent = 'Rapor Oluşturuluyor...';

            // Formu fetch ile gönder
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData
            });

            if (response.redirected) {
                window.location.href = response.url;
            } else {
                const result = await response.json();
                if (result.error) {
                    throw new Error(result.error);
                }
            }
        } catch (error) {
            console.error('Hata:', error);
            errorDiv.textContent = 'Hata: ' + error.message;
            errorDiv.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Rapor Oluştur';
        }
    });
</script>

</body>
</html>
